<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OY è³¼ç‰©ç®¡å®¶ - æ——è‰¦å®Œå‚™ç‰ˆ</title>
    <style>
        :root { --primary: #f05a28; --secondary: #97c024; --bg: #f2f2f7; --cart: #2ecc71; --tax: #e67e22; --win: #ffd700; --must: #e74c3c; --want: #3498db; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: 10px; padding-bottom: 260px; color: #333; }
        .card { background: white; border-radius: 16px; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 15px; }
        h2 { color: var(--primary); text-align: center; margin: 5px 0 15px 0; font-size: 20px; }
        
        /* è¡¨å–®å€åŸŸ */
        .form-group { display: flex; flex-direction: column; gap: 10px; }
        .input-row { display: flex; gap: 8px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; outline: none; box-sizing: border-box; }
        
        /* è¦æ ¼å°å¡ç‰‡ - è§£æ±ºæ’ç‰ˆå‡¸å‡ºå•é¡Œ */
        .spec-entry { background: #f9f9f9; padding: 12px; border-radius: 10px; border: 1px solid #eee; position: relative; }
        .spec-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
        .full-width { grid-column: span 2; }
        .spec-label { font-size: 11px; color: #777; margin-bottom: 2px; }

        .btn-main { background: var(--primary); color: white; padding: 14px; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 5px; }
        .btn-sub { background: #eee; color: #444; padding: 8px; border: none; border-radius: 8px; font-size: 12px; font-weight: bold; }
        .btn-del { position: absolute; right: -5px; top: -5px; background: #ff4d4d; color: white; border: none; width: 22px; height: 22px; border-radius: 50%; font-size: 12px; }

        /* å°è¦½ */
        .nav-tabs { display: flex; background: white; border-radius: 12px; margin-bottom: 15px; padding: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .nav-btn { flex: 1; padding: 10px; border: none; background: none; font-weight: bold; color: #888; border-radius: 8px; }
        .nav-btn.active { background: var(--primary); color: white; }

        /* ç”¢å“å¡ç‰‡ */
        .item-card { background: white; border-radius: 15px; margin-bottom: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: relative; }
        .item-card.in-cart { border: 2px solid var(--cart); }
        .prod-img { width: 100%; height: 140px; object-fit: contain; background: #fff; border-bottom: 1px solid #f0f0f0; }
        .prod-info { padding: 12px; }
        .priority-badge { position: absolute; top: 10px; right: 10px; font-size: 10px; padding: 3px 8px; border-radius: 20px; color: white; font-weight: bold; z-index: 5; }
        
        .price-display { background: #fffdf0; padding: 8px; border-radius: 8px; margin-bottom: 5px; border: 1px solid #ffeaa7; }
        .price-tag { color: #e74c3c; font-weight: bold; font-size: 16px; }
        .old-price { text-decoration: line-through; color: #999; font-size: 12px; margin-left: 5px; }
        .expiry-info { font-size: 11px; color: #e67e22; font-weight: bold; display: block; margin-top: 3px; }

        /* åº•éƒ¨çµå¸³æ¬„ */
        .checkout-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); z-index: 100; border-radius: 20px 20px 0 0; }
        .sum-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px; }
        .total-row { color: var(--primary); font-size: 22px; font-weight: 900; border-top: 1px solid #eee; padding-top: 8px; margin-top: 8px; }

        .history-panel { display: none; font-size: 11px; background: #f0f7ff; padding: 10px; border-radius: 8px; margin: 8px 0; border: 1px solid #cce2ff; }
        .page { display: none; }
        .page.active { display: block; }
    </style>
</head>
<body>

<div class="nav-tabs">
    <button class="nav-btn active" onclick="switchPage('wishlist', this)">é¡˜æœ›æ¸…å–®</button>
    <button class="nav-btn" onclick="switchPage('cart', this)">è³¼ç‰©ç±ƒ (<span id="cart-count">0</span>)</button>
</div>

<div id="wishlist-page" class="page active">
    <div class="card">
        <h2>âœ¨ æ–°å¢æ¡è³¼é …ç›®</h2>
        <div class="form-group">
            <input type="text" id="name" placeholder="ç”¢å“åç¨± (å¿…å¡«)">
            <div class="input-row">
                <input type="text" id="imgUrl" placeholder="åœ–ç‰‡ç¶²å€ (å¯é¸)">
                <input type="text" id="prodLink" placeholder="ç”¢å“é€£çµ (å¯é¸)">
            </div>
            <div class="input-row">
                <select id="priority">
                    <option value="å¿…è²·">ğŸ”¥ å¿…è²·</option>
                    <option value="æƒ³è²·" selected>ğŸ›ï¸ æƒ³è²·</option>
                    <option value="æ„Ÿèˆˆè¶£">âœ¨ æ„Ÿèˆˆè¶£</option>
                </select>
                <select id="mainCat" onchange="updateSubCat()">
                    <option value="è­·è†šå“">è­·è†šå“</option>
                    <option value="åŒ–å¦å“">åŒ–å¦å“</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
            </div>
            <div id="subCatArea"></div>
            
            <div id="specs-container"></div>
            <button class="btn-sub" onclick="addSpecInput()">ï¼‹å¢åŠ å°æ¯”è¦æ ¼</button>
            <button class="btn-main" onclick="saveProduct()">å„²å­˜è‡³æ¸…å–®</button>
        </div>
    </div>
    <div id="wish-list-container"></div>
</div>

<div id="cart-page" class="page">
    <div class="card"><h2>ğŸ›’ è³¼ç‰©ç±ƒæ¸…å–®</h2><div id="cart-list-container"></div></div>
</div>

<div class="checkout-bar">
    <div class="sum-row" style="color:var(--must); font-weight:bold;"><span>å¿…è²·å°è¨ˆ</span><span>â‚©<span id="must-total">0</span></span></div>
    <div class="sum-row"><span>ç¸½è¨ˆ</span><span>â‚©<span id="total-amount">0</span></span></div>
    <div class="sum-row" style="color:var(--tax);"><span>é ä¼°é€€ç¨…</span><span>- â‚©<span id="refund-amount">0</span></span></div>
    <div class="sum-row total-row"><span>é ç®—å¯¦ä»˜</span><span>â‚©<span id="final-amount">0</span></span></div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('oy_flagship_v14')) || [];
    let cart = JSON.parse(localStorage.getItem('oy_cart_v14')) || [];

    function updateSubCat() {
        const main = document.getElementById('mainCat').value;
        const area = document.getElementById('subCatArea');
        if (main === "å…¶ä»–") {
            area.innerHTML = `<input type="text" id="subCat" placeholder="è‡ªå®šç¾©é¡åˆ¥ (å¦‚:é›¶é£Ÿ)">`;
        } else {
            const subs = main === "è­·è†šå“" ? ["Mask", "Serum", "Toner", "Cream"] : ["Lip", "Foundation", "Eye"];
            area.innerHTML = `<select id="subCat">${subs.map(s => `<option value="${s}">${s}</option>`).join('')}</select>`;
        }
    }

    function addSpecInput() {
        const div = document.createElement('div');
        div.className = 'spec-entry';
        div.innerHTML = `
            <button class="btn-del" onclick="this.parentElement.remove()">âœ•</button>
            <div class="spec-grid">
                <div><div class="spec-label">å…¥æ•¸</div><input type="number" class="spec-qty" placeholder="1"></div>
                <div><div class="spec-label">åŸåƒ¹ â‚©</div><input type="number" class="spec-orig" placeholder="20000"></div>
                <div><div class="spec-label">ç‰¹åƒ¹ â‚© (é¸å¡«)</div><input type="number" class="spec-sale" placeholder="15000"></div>
                <div><div class="spec-label">ç‰¹åƒ¹æˆªæ­¢ (é¸å¡«)</div><input type="date" class="spec-until"></div>
            </div>
        `;
        document.getElementById('specs-container').appendChild(div);
    }

    function saveProduct() {
        const name = document.getElementById('name').value;
        if (!name) return alert('è«‹å¡«å¯«ç”¢å“åç¨±');
        
        let specs = [];
        document.querySelectorAll('.spec-entry').forEach(div => {
            const q = Number(div.querySelector('.spec-qty').value);
            const o = Number(div.querySelector('.spec-orig').value);
            const s = Number(div.querySelector('.spec-sale').value);
            const u = div.querySelector('.spec-until').value;
            const finalP = s || o;
            if (q && finalP) specs.push({ qty: q, orig: o, sale: s, until: u, unit: Math.round(finalP/q) });
        });

        if (specs.length === 0) return alert('è«‹è‡³å°‘å¡«å¯«ä¸€çµ„æœ‰æ•ˆè¦æ ¼');

        const product = {
            id: Date.now(), name, 
            imgUrl: document.getElementById('imgUrl').value,
            prodLink: document.getElementById('prodLink').value,
            priority: document.getElementById('priority').value,
            mainCat: document.getElementById('mainCat').value,
            subCat: document.getElementById('subCat').value,
            specs, history: []
        };

        let oldIdx = db.findIndex(p => p.name === name);
        if (oldIdx > -1) {
            product.history = [...db[oldIdx].history, { date: new Date().toLocaleDateString(), specs: db[oldIdx].specs }];
            db[oldIdx] = product;
        } else {
            db.push(product);
        }

        localStorage.setItem('oy_flagship_v14', JSON.stringify(db));
        resetForm(); render();
    }

    function render() {
        const wishC = document.getElementById('wish-list-container');
        const cartC = document.getElementById('cart-list-container');
        wishC.innerHTML = ''; cartC.innerHTML = '';
        let total = 0, mustT = 0, cartQty = 0;

        db.sort((a,b) => (a.priority === 'å¿…è²·' ? -1 : 1)).forEach(p => {
            const inCart = cart.includes(p.id);
            const minUnit = Math.min(...p.specs.map(s => s.unit));
            const specHtml = p.specs.map(s => `
                <div class="price-display ${s.unit === minUnit && p.specs.length > 1 ? 'best' : ''}">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span>${s.qty}å…¥: <span class="price-tag">â‚©${(s.sale || s.orig).toLocaleString()}</span>${s.sale ? `<span class="old-price">â‚©${s.orig.toLocaleString()}</span>` : ''}</span>
                        <span style="font-size:11px; background:#eee; padding:2px 5px; border-radius:4px;">å–®åƒ¹ â‚©${s.unit}</span>
                    </div>
                    ${s.sale && s.until ? `<span class="expiry-info">â³ ç‰¹åƒ¹è‡³ ${s.until}</span>` : ''}
                </div>`).join('');

            const card = `
                <div class="item-card ${inCart ? 'in-cart' : ''}">
                    <span class="priority-badge" style="background:${p.priority==='å¿…è²·'?'#e74c3c':(p.priority==='æƒ³è²·'?'#3498db':'#95a5a6')}">${p.priority}</span>
                    ${p.imgUrl ? `<img src="${p.imgUrl}" class="prod-img">` : ''}
                    <div class="prod-info">
                        <div style="font-size:11px; color:#888;">${p.mainCat} > ${p.subCat}</div>
                        <a href="${p.prodLink || '#'}" target="_blank" style="text-decoration:none; color:#333; font-weight:bold; font-size:16px; display:block; margin:5px 0;">${p.name} ${p.prodLink?'ğŸ”—':''}</a>
                        ${specHtml}
                        <div onclick="toggleH(${p.id})" style="color:#3498db; font-size:11px; text-decoration:underline; margin:5px 0; cursor:pointer;">ğŸ“Š åƒ¹æ ¼æ­·å² (${p.history.length})</div>
                        <div id="h-${p.id}" class="history-panel">${p.history.map(h => `<div>${h.date}: â‚©${h.specs[0].unit}/å…¥</div>`).join('') || 'å°šç„¡ç´€éŒ„'}</div>
                        <button class="btn-main" style="background:${inCart? '#2ecc71':'#f0f0f0'}; color:${inCart?'white':'#444'}; width:100%;" onclick="toggleCart(${p.id})">${inCart?'âŒ ç§»å‡ºè³¼ç‰©ç±ƒ':'â• æ”¾å…¥è³¼ç‰©ç±ƒ'}</button>
                    </div>
                </div>`;
            wishC.innerHTML += card;
            if (inCart) { cartC.innerHTML += card; total += (p.specs[0].sale || p.specs[0].orig); cartQty++; if(p.priority==='å¿…è²·') mustT += (p.specs[0].sale || p.specs[0].orig); }
        });

        // é€€ç¨…è¨ˆç®—
        const taxTable = [{ min: 15000, max: 29999, refund: 1000 }, { min: 30000, max: 49999, refund: 2000 }, { min: 50000, max: 74999, refund: 3000 }, { min: 75000, max: 99999, refund: 5000 }, { min: 100000, max: 124999, refund: 7000 }, { min: 125000, max: 149999, refund: 8000 }, { min: 150000, max: 174999, refund: 9000 }, { min: 175000, max: 199999, refund: 10000 }, { min: 200000, max: 224999, refund: 12000 }];
        const tier = taxTable.find(t => total >= t.min && total <= t.max);
        const refund = tier ? tier.refund : (total >= 225000 ? Math.round(total * 0.06) : 0);
        
        document.getElementById('must-total').innerText = mustT.toLocaleString();
        document.getElementById('total-amount').innerText = total.toLocaleString();
        document.getElementById('refund-amount').innerText = refund.toLocaleString();
        document.getElementById('final-amount').innerText = (total - refund).toLocaleString();
        document.getElementById('cart-count').innerText = cartQty;
    }

    function toggleH(id) { const el = document.getElementById('h-'+id); el.style.display = el.style.display === 'block' ? 'none' : 'block'; }
    function toggleCart(id) { const idx = cart.indexOf(id); if (idx > -1) cart.splice(idx, 1); else cart.push(id); localStorage.setItem('oy_cart_v14', JSON.stringify(cart)); render(); }
    function switchPage(p, btn) { document.querySelectorAll('.page').forEach(x => x.classList.remove('active')); document.getElementById(p + '-page').classList.add('active'); document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); render(); }
    function resetForm() { document.getElementById('name').value = ''; document.getElementById('imgUrl').value = ''; document.getElementById('prodLink').value = ''; document.getElementById('specs-container').innerHTML = ''; addSpecInput(); }
    
    updateSubCat(); addSpecInput(); render();
</script>
</body>
</html>
