<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OY çµ‚æ¥µç®¡ç†å°ˆå®¶ - é€€ç¨…è¨ˆç®—ç‰ˆ</title>
    <style>
        :root { --primary: #f05a28; --secondary: #97c024; --bg: #f2f2f7; --cart: #2ecc71; --plan: #9b59b6; --history: #34495e; --must: #e74c3c; --tax: #3498db; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; padding-bottom: 280px; color: #333; font-size: 14px; }
        .card { background: white; border-radius: 16px; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 12px; }
        h2 { color: var(--primary); text-align: center; font-size: 18px; margin-bottom: 15px; }
        
        .nav-tabs { display: flex; background: white; border-radius: 12px; margin-bottom: 15px; padding: 5px; position: sticky; top: 10px; z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .nav-btn { flex: 1; padding: 10px 2px; border: none; background: none; font-weight: bold; color: #888; border-radius: 8px; font-size: 11px; cursor: pointer; }
        .nav-btn.active { background: var(--primary); color: white; }

        .filter-bar { display: flex; gap: 8px; overflow-x: auto; padding: 5px 0 12px 0; }
        .filter-tag { padding: 6px 15px; background: white; border-radius: 20px; font-size: 12px; color: #666; box-shadow: 0 2px 5px rgba(0,0,0,0.05); white-space: nowrap; }
        .filter-tag.active { background: var(--primary); color: white; }

        .form-group { display: flex; flex-direction: column; gap: 8px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box; outline: none; }
        .price-section { background: #fffcf0; padding: 12px; border-radius: 10px; border: 1px solid #ffeaa7; }

        .item-card { background: white; border-radius: 15px; margin-bottom: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .spec-box { border: 1px solid #f0f0f0; padding: 10px; border-radius: 8px; margin-top: 8px; background: #fafafa; }
        .price-now { color: var(--must); font-weight: bold; font-size: 16px; }

        .hist-card { border-left: 5px solid var(--history); cursor: pointer; }
        .hist-detail { display: none; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ccc; font-size: 12px; }
        .hist-detail.active { display: block; }

        .checkout-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); z-index: 1000; border-radius: 20px 20px 0 0; }
        .tax-info { color: var(--tax); font-weight: bold; }
        .page { display: none; }
        .page.active { display: block; }
    </style>
</head>
<body>

<div class="nav-tabs">
    <button class="nav-btn active" onclick="switchPage('wishlist', this)">âœš ç™»è¨˜</button>
    <button class="nav-btn" onclick="switchPage('dashboard', this)">ğŸ“‹ æ¸…å–®</button>
    <button class="nav-btn" onclick="switchPage('plan', this)">ğŸ“ è¨ˆç•«</button>
    <button class="nav-btn" onclick="switchPage('cart', this)">ğŸ›’ ç±ƒå­</button>
    <button class="nav-btn" onclick="switchPage('history', this)">ğŸ“œ ç´€éŒ„</button>
</div>

<div id="wishlist-page" class="page active">
    <div class="card">
        <h2>âœ¨ ç”¢å“èˆ‡è¦æ ¼ç™»è¨˜</h2>
        <div class="form-group">
            <input type="text" id="name" placeholder="ç”¢å“åç¨±" oninput="checkExisting()">
            <div id="existHint" style="display:none; font-size:11px; color:var(--secondary); margin-top:-5px; font-weight:bold;">âš ï¸ åµæ¸¬åˆ°ç¾æœ‰ç”¢å“ï¼Œå°‡æ·»åŠ æ–°è¦æ ¼</div>
            <select id="subCat" onchange="handleSubChange()">
                <optgroup label="ğŸŒ¿ è­·è†šå“">
                    <option value="åŒ–å¦æ°´">åŒ–å¦æ°´</option><option value="ç²¾è¯">ç²¾è¯</option><option value="ä¹³æ¶²">ä¹³æ¶²</option>
                    <option value="é¢éœœ">é¢éœœ</option><option value="é¢è†œ">é¢è†œ</option><option value="é˜²æ›¬">é˜²æ›¬</option>
                    <option value="æ½”é¢">æ½”é¢</option><option value="å¸å¦">å¸å¦</option>
                </optgroup>
                <optgroup label="ğŸ’„ åŒ–å¦å“">
                    <option value="å¦å‰">å¦å‰</option><option value="æ°£å¢Š">æ°£å¢Š</option><option value="ç²‰åº•">ç²‰åº•</option>
                    <option value="é®ç‘•">é®ç‘•</option><option value="è…®ç´…">è…®ç´…</option><option value="é«˜å…‰">é«˜å…‰</option>
                    <option value="ä¿®å®¹">ä¿®å®¹</option><option value="çœ‰ç­†">çœ‰ç­†</option><option value="çœ¼å½±">çœ¼å½±</option>
                    <option value="çœ¼ç·š/è‡¥è ¶">çœ¼ç·š/è‡¥è ¶</option><option value="ç«æ¯›è†">ç«æ¯›è†</option><option value="å”‡ç·šç­†">å”‡ç·šç­†</option>
                    <option value="å”‡é‡‰">å”‡é‡‰</option><option value="å”‡è†">å”‡è†</option>
                </optgroup>
                <optgroup label="ğŸš¿ å€‹äººè­·ç†">
                    <option value="æ‰‹éƒ¨è­·ç†">æ‰‹éƒ¨è­·ç†</option><option value="å£è…”æ¸…æ½”">å£è…”æ¸…æ½”</option><option value="é¦™æ°›/é¦™æ°´">é¦™æ°›/é¦™æ°´</option>
                </optgroup>
                <optgroup label="ğŸ“¦ å…¶ä»–">
                    <option value="ç¾å®¹å·¥å…·">ç¾å®¹å·¥å…·</option><option value="é›¶é£Ÿ">é›¶é£Ÿ</option><option value="ç”Ÿæ´»é›œè²¨">ç”Ÿæ´»é›œè²¨</option>
                </optgroup>
            </select>
            <div id="usageArea" style="display:none;"><select id="usageType"><option value="çœ¼ç·š">ğŸ–Šï¸ åŠŸèƒ½ï¼šçœ¼ç·š</option><option value="è‡¥è ¶">âœ¨ åŠŸèƒ½ï¼šè‡¥è ¶</option></select></div>
            <div class="price-section">
                <input type="text" id="spec" placeholder="è¦æ ¼ (å¦‚: 1+1, 200ml)">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px; margin-top:8px;">
                    <input type="number" id="priceOrig" placeholder="åŸåƒ¹ â‚©">
                    <input type="number" id="priceSale" placeholder="ç‰¹åƒ¹ â‚©">
                </div>
                <div style="margin-top:8px;"><small>ç‰¹åƒ¹æˆªæ­¢:</small> <input type="date" id="priceUntil"></div>
            </div>
            <button class="btn-main" onclick="saveProduct()">å„²å­˜è¦æ ¼è³‡æ–™</button>
        </div>
    </div>
</div>

<div id="dashboard-page" class="page">
    <div class="filter-bar">
        <div class="filter-tag active" onclick="setFilter('å…¨éƒ¨', this)">å…¨éƒ¨</div>
        <div class="filter-tag" onclick="setFilter('è­·è†šå“', this)">è­·è†š</div>
        <div class="filter-tag" onclick="setFilter('Base', this)">Base</div>
        <div class="filter-tag" onclick="setFilter('Eyes', this)">Eyes</div>
        <div class="filter-tag" onclick="setFilter('Lip', this)">Lip</div>
        <div class="filter-tag" onclick="setFilter('å€‹äººè­·ç†', this)">å€‹è­·</div>
    </div>
    <div class="card" style="margin-top:0;"><input type="text" id="search" placeholder="ğŸ” æœç´¢ç”¢å“..." oninput="render()"></div>
    <div id="dash-list"></div>
</div>

<div id="plan-page" class="page"><div id="plan-list"></div></div>
<div id="cart-page" class="page"><div id="cart-list"></div><div class="card"><input type="text" id="checkoutName" placeholder="è³¼ç‰©ç´€éŒ„åç¨±"><button class="btn-main" style="background:var(--history); margin-top:10px;" onclick="archiveCart()">çµå¸³å­˜æª”</button></div></div>
<div id="history-page" class="page"><div id="history-list"></div></div>

<div id="specModal" class="modal" onclick="closeModal()"><div class="modal-content" onclick="event.stopPropagation()"><h3>é¸æ“‡è¦æ ¼</h3><div id="modalSpecList"></div></div></div>

<div class="checkout-bar">
    <div style="display:flex; justify-content:space-between; font-size:11px;"><span>ğŸ“ è¨ˆç•«é ç®—</span><span>â‚©<span id="plan-total">0</span></span></div>
    <div style="display:flex; justify-content:space-between; font-size:11px; color:var(--cart);"><span>ğŸ›’ ç±ƒå­ç¸½è¨ˆ</span><span>â‚©<span id="cart-total">0</span></span></div>
    <div style="display:flex; justify-content:space-between; font-size:12px; margin:4px 0;" class="tax-info"><span>ğŸ’° é è¨ˆé€€ç¨…é¡</span><span>- â‚©<span id="tax-refund">0</span></span></div>
    <div style="font-weight:bold; color:var(--primary); border-top:1px solid #eee; margin-top:5px; padding-top:8px; display:flex; justify-content:space-between; font-size:16px;"><span>é€€ç¨…å¾Œå¯¦ä»˜</span><span>â‚©<span id="final-total">0</span></span></div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('oy_db_v90')) || [];
    let cart = JSON.parse(localStorage.getItem('oy_cart_v90')) || [];
    let plan = JSON.parse(localStorage.getItem('oy_plan_v90')) || [];
    let history = JSON.parse(localStorage.getItem('oy_hist_v90')) || [];
    let currentFilter = 'å…¨éƒ¨';

    // æ ¹æ“šä¸Šå‚³åœ–ç‰‡æ•´ç†çš„é€€ç¨…ç´šè·è¡¨ (éƒ¨åˆ†ç²¾é¸)
    function calculateRefund(amount) {
        if (amount < 15000) return 0;
        if (amount < 30000) return 1000;
        if (amount < 50000) return 2000;
        if (amount < 75000) return 3000;
        if (amount < 100000) return 5000;
        if (amount < 125000) return 7000;
        if (amount < 150000) return 8000;
        if (amount < 175000) return 9000;
        if (amount < 200000) return 10000;
        if (amount < 225000) return 12000;
        if (amount < 250000) return 13000;
        if (amount < 275000) return 15000;
        if (amount < 300000) return 17000;
        if (amount < 400000) return 20000 + (Math.floor((amount-300000)/25000)*2000); // ç°¡åŒ–é‚è¼¯
        if (amount < 500000) return 30000 + (Math.floor((amount-450000)/25000)*2000);
        return Math.floor(amount * 0.06); // è¶…éå¤§é¡ä»¥ç´„6%è¨ˆ
    }

    const categoryMap = { "å¦å‰":"Base","æ°£å¢Š":"Base","ç²‰åº•":"Base","é®ç‘•":"Base","è…®ç´…":"Base","é«˜å…‰":"Base","ä¿®å®¹":"Base","çœ‰ç­†":"Eyes","çœ¼å½±":"Eyes","çœ¼ç·š/è‡¥è ¶":"Eyes","ç«æ¯›è†":"Eyes","å”‡ç·šç­†":"Lip","å”‡é‡‰":"Lip","å”‡è†":"Lip" };
    function checkExisting() { document.getElementById('existHint').style.display = db.some(p => p.name === document.getElementById('name').value.trim()) ? 'block' : 'none'; }
    function handleSubChange() { document.getElementById('usageArea').style.display = (document.getElementById('subCat').value === 'çœ¼ç·š/è‡¥è ¶') ? 'block' : 'none'; }
    function setFilter(f, el) { currentFilter = f; document.querySelectorAll('.filter-tag').forEach(t => t.classList.remove('active')); el.classList.add('active'); render(); }

    function saveProduct() {
        const name = document.getElementById('name').value.trim();
        const sub = document.getElementById('subCat').value;
        if(!name) return alert("åç¨±å¿…å¡«");
        let main = "å…¶ä»–";
        if(categoryMap[sub]) main = "åŒ–å¦å“_" + categoryMap[sub];
        else if(["åŒ–å¦æ°´","ç²¾è¯","ä¹³æ¶²","é¢éœœ","é¢è†œ","é˜²æ›¬","æ½”é¢","å¸å¦"].includes(sub)) main = "è­·è†šå“";
        else if(["æ‰‹éƒ¨è­·ç†","å£è…”æ¸…æ½”","é¦™æ°›/é¦™æ°´"].includes(sub)) main = "å€‹äººè­·ç†";

        const specData = { specId: Date.now(), name: document.getElementById('spec').value || "æ¨™æº–", usage: (sub === 'çœ¼ç·š/è‡¥è ¶') ? document.getElementById('usageType').value : "", orig: Number(document.getElementById('priceOrig').value), sale: Number(document.getElementById('priceSale').value), until: document.getElementById('priceUntil').value };
        let product = db.find(p => p.name === name);
        if(product) product.specs.push(specData); else db.push({ id: Date.now(), name, main, sub, specs: [specData] });
        localStorage.setItem('oy_db_v90', JSON.stringify(db)); render(); alert("è¦æ ¼å·²åŠ å…¥ï¼");
    }

    function render() {
        const search = document.getElementById('search').value.toLowerCase();
        const dashCont = document.getElementById('dash-list'); dashCont.innerHTML = '';
        const planCont = document.getElementById('plan-list'); planCont.innerHTML = '';
        const cartCont = document.getElementById('cart-list'); cartCont.innerHTML = '';
        const histCont = document.getElementById('history-list'); histCont.innerHTML = '';
        let pT = 0, cT = 0;

        db.forEach(p => {
            if(!p.name.toLowerCase().includes(search) || (currentFilter !== 'å…¨éƒ¨' && !p.main.includes(currentFilter))) return;
            dashCont.innerHTML += `<div class="item-card"><small>${p.main.split('_').pop()} > ${p.sub}</small><div style="font-weight:bold;">${p.name}</div><div style="font-size:12px; color:#888;">${p.specs.length} å€‹è¦æ ¼</div><div style="display:flex; gap:5px; margin-top:8px;"><button class="nav-btn" style="background:var(--plan); color:white; padding:8px;" onclick="openPicker(${p.id}, 'plan')">ï¼‹è¨ˆç•«</button><button class="nav-btn" style="background:var(--cart); color:white; padding:8px;" onclick="openPicker(${p.id}, 'cart')">ï¼‹ç±ƒå­</button></div></div>`;
        });

        const drawList = (list, cont, key) => {
            list.forEach((item, idx) => {
                const p = db.find(x => x.id === item.prodId);
                const s = p.specs.find(x => x.specId === item.specId);
                const price = s.sale || s.orig;
                if(key.includes('plan')) pT += price * item.qty; else cT += price * item.qty;
                cont.innerHTML += `<div class="item-card" style="border-left:5px solid ${key.includes('plan')?'var(--plan)':'var(--cart)'}"><div style="display:flex; justify-content:space-between;"><b>${p.name}</b><button onclick="remove('${key}', ${idx})" style="border:none; color:red; background:none;">âœ•</button></div><div style="font-size:12px;">${s.name} ${s.usage?'('+s.usage+')':''}</div><div style="display:flex; justify-content:space-between; margin-top:5px;"><span class="price-now">â‚©${price.toLocaleString()}</span><input type="number" value="${item.qty}" onchange="updateQty('${key}', ${idx}, this.value)" style="width:45px;"></div></div>`;
            });
        };
        drawList(plan, planCont, 'oy_plan_v90'); drawList(cart, cartCont, 'oy_cart_v90');

        history.forEach((h, idx) => {
            histCont.innerHTML += `<div class="card hist-card" onclick="this.querySelector('.hist-detail').classList.toggle('active')"><div style="display:flex; justify-content:space-between;"><div><b>${h.title}</b><br><small>${h.date}</small></div><div style="text-align:right;"><b style="color:var(--primary);">â‚©${h.total.toLocaleString()}</b><br><small>é€€ç¨… â‚©${calculateRefund(h.total).toLocaleString()}</small></div></div><div class="hist-detail">${h.items.map(i=>`<div style="display:flex; justify-content:space-between; margin-bottom:3px;"><span>${i.prodName}<br><small>${i.specName}</small></span><span>â‚©${i.price.toLocaleString()} x ${i.qty}</span></div>`).join('')}<button onclick="deleteHist(event, ${idx})" style="width:100%; border:none; color:red; background:#fff5f5; padding:5px; margin-top:8px;">ğŸ—‘ï¸ åˆªé™¤</button></div></div>`;
        });

        const refund = calculateRefund(cT);
        document.getElementById('plan-total').innerText = pT.toLocaleString();
        document.getElementById('cart-total').innerText = cT.toLocaleString();
        document.getElementById('tax-refund').innerText = refund.toLocaleString();
        document.getElementById('final-total').innerText = (cT - refund).toLocaleString();
    }

    function openPicker(id, target) {
        const p = db.find(x => x.id === id);
        document.getElementById('modalSpecList').innerHTML = p.specs.map(s => `<div class="spec-box" onclick="add(${p.id}, ${s.specId}, '${target}')"><b>${s.name}</b><br><span class="price-now">â‚©${(s.sale || s.orig).toLocaleString()}</span></div>`).join('');
        document.getElementById('specModal').style.display = 'flex';
    }
    function add(prodId, specId, target) { let list = (target==='plan')?plan:cart; list.push({prodId, specId, qty:1}); localStorage.setItem('oy_'+target+'_v90', JSON.stringify(list)); closeModal(); render(); }
    function remove(key, idx) { let list = JSON.parse(localStorage.getItem(key)); list.splice(idx,1); localStorage.setItem(key, JSON.stringify(list)); if(key.includes('plan')) plan=list; else cart=list; render(); }
    function updateQty(key, idx, val) { let list = JSON.parse(localStorage.getItem(key)); list[idx].qty = parseInt(val)||1; localStorage.setItem(key, JSON.stringify(list)); if(key.includes('plan')) plan=list; else cart=list; render(); }
    function archiveCart() { if(!cart.length) return; const items = cart.map(item => { const p=db.find(x=>x.id===item.prodId); const s=p.specs.find(x=>x.specId===item.specId); return {prodName:p.name, specName:s.name, price:(s.sale||s.orig), qty:item.qty}; }); const total = items.reduce((sum, i)=>sum+(i.price*i.qty),0); history.unshift({title:document.getElementById('checkoutName').value||"æ¡è³¼ç´€éŒ„", date:new Date().toLocaleString(), items, total}); localStorage.setItem('oy_hist_v90', JSON.stringify(history)); cart=[]; localStorage.setItem('oy_cart_v90','[]'); render(); alert("çµå¸³å®Œæˆï¼"); }
    function deleteHist(e, idx) { e.stopPropagation(); if(confirm("åˆªé™¤ï¼Ÿ")){history.splice(idx,1); localStorage.setItem('oy_hist_v90', JSON.stringify(history)); render();}}
    function switchPage(p, btn) { document.querySelectorAll('.page').forEach(x=>x.classList.remove('active')); document.getElementById(p+'-page').classList.add('active'); document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
    function closeModal() { document.getElementById('specModal').style.display = 'none'; }
    render();
</script>
</body>
</html>