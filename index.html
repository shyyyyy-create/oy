<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OY çµ‚æ¥µç®¡ç†å°ˆå®¶</title>
    <style>
        :root { --primary: #f05a28; --secondary: #97c024; --bg: #f2f2f7; --cart: #2ecc71; --plan: #9b59b6; --history: #34495e; --tax: #e67e22; --must: #e74c3c; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; padding-bottom: 260px; color: #333; }
        .card { background: white; border-radius: 16px; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 15px; }
        h2 { color: var(--primary); text-align: center; font-size: 18px; margin: 5px 0 10px 0; }
        
        /* é ‚éƒ¨å°èˆª - ç¢ºä¿äº”å€‹æŒ‰éˆ•éƒ½èƒ½é» */
        .nav-tabs { display: flex; background: white; border-radius: 12px; margin-bottom: 15px; padding: 5px; position: sticky; top: 10px; z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .nav-btn { flex: 1; padding: 10px 2px; border: none; background: none; font-weight: bold; color: #888; border-radius: 8px; font-size: 11px; cursor: pointer; }
        .nav-btn.active { background: var(--primary); color: white; }

        /* æœç´¢èˆ‡ç¯©é¸ Tags */
        .filter-tags { display: flex; gap: 6px; overflow-x: auto; padding: 5px 0; margin-top: 8px; }
        .tag { padding: 6px 12px; background: white; border: 1px solid #ddd; border-radius: 20px; font-size: 11px; white-space: nowrap; cursor: pointer; }
        .tag.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* è¡¨å–®èˆ‡è¼¸å…¥ */
        .form-group { display: flex; flex-direction: column; gap: 10px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box; outline: none; }
        .btn-main { background: var(--primary); color: white; padding: 14px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; width: 100%; }

        /* ç”¢å“å¡ç‰‡æ¨£å¼ */
        .item-card { background: white; border-radius: 15px; margin-bottom: 12px; padding: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .item-card.in-plan { border-left: 5px solid var(--plan); }
        .item-card.in-cart { border-right: 5px solid var(--cart); }
        .price-tag { color: var(--must); font-weight: bold; font-size: 16px; }

        /* æ“ç¸±å€ */
        .buy-controls { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }
        .btn-act { flex: 1; padding: 10px; border: none; border-radius: 8px; font-weight: bold; font-size: 11px; cursor: pointer; }
        .btn-p { background: var(--plan); color: white; }
        .btn-c { background: var(--cart); color: white; }
        .btn-off { background: #eee; color: #888; }
        .qty-row { display: flex; align-items: center; justify-content: space-between; font-size: 12px; background: #f9f9f9; padding: 5px 10px; border-radius: 8px; }

        /* æ­·å²ç´€éŒ„æ¨£å¼ */
        .history-item { border-left: 5px solid var(--history); margin-bottom: 15px; }
        .history-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed #ddd; padding-bottom: 5px; }

        /* åº•éƒ¨è¨ˆç®—æ¬„ */
        .checkout-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); z-index: 1000; border-radius: 20px 20px 0 0; }
        .sum-row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 2px; }
        .total-row { color: var(--primary); font-size: 18px; font-weight: 900; border-top: 1px solid #eee; padding-top: 8px; }

        .page { display: none; }
        .page.active { display: block; }
        .empty-hint { text-align: center; color: #999; padding: 40px 20px; font-size: 14px; }
    </style>
</head>
<body>

<div class="nav-tabs">
    <button class="nav-btn active" onclick="switchPage('wishlist', this)">âœš ç™»è¨˜</button>
    <button class="nav-btn" onclick="switchPage('dashboard', this)">ğŸ“‹ æ¸…å–®</button>
    <button class="nav-btn" onclick="switchPage('plan', this)">ğŸ“ è¨ˆç•«</button>
    <button class="nav-btn" onclick="switchPage('cart', this)">ğŸ›’ ç±ƒå­</button>
    <button class="nav-btn" onclick="switchPage('history', this)">ğŸ“œ ç´€éŒ„</button>
</div>

<div id="wishlist-page" class="page active">
    <div class="card">
        <h2>âœ¨ ç™»è¨˜ç”¢å“</h2>
        <div class="form-group">
            <input type="text" id="name" placeholder="ç”¢å“åç¨± (å¿…å¡«)">
            <div style="display:flex; gap:8px;">
                <select id="mainCat" onchange="toggleMakeupSub()">
                    <option value="è­·è†šå“">ğŸŒ¿ è­·è†šå“</option>
                    <option value="åŒ–å¦å“">ğŸ’„ åŒ–å¦å“</option>
                    <option value="å€‹äººè­·ç†">ğŸš¿ å€‹äººè­·ç†</option>
                    <option value="å…¶ä»–">ğŸ“¦ å…¶ä»–</option>
                </select>
                <div id="mk-sub-area" style="display:none; flex:1;">
                    <select id="mkType" onchange="updateSubCat()">
                        <option value="Base">Base</option>
                        <option value="Eyes">Eyes</option>
                        <option value="Lip">Lip</option>
                    </select>
                </div>
            </div>
            <div id="subCatArea"></div>
            <div style="display:flex; gap:8px;">
                <input type="number" id="price" placeholder="åƒ¹æ ¼ â‚©">
                <input type="text" id="spec" placeholder="è¦æ ¼ (1+1)">
            </div>
            <select id="priority"><option value="å¿…è²·">ğŸ”¥ å¿…è²·</option><option value="æƒ³è²·">ğŸ›ï¸ æƒ³è²·</option><option value="æ„Ÿèˆˆè¶£">âœ¨ æ„Ÿèˆˆè¶£</option></select>
            <button class="btn-main" onclick="saveProduct()">å„²å­˜è‡³ç”¢å“åº«</button>
        </div>
    </div>
</div>

<div id="dashboard-page" class="page">
    <div class="card">
        <input type="text" id="search" placeholder="ğŸ” æœç´¢ç”¢å“..." oninput="render()">
        <div class="filter-tags">
            <div class="tag active" onclick="setFilter('å…¨éƒ¨', this)">å…¨éƒ¨</div>
            <div class="tag" onclick="setFilter('è­·è†šå“', this)">è­·è†š</div>
            <div class="tag" onclick="setFilter('Base', this)">Base</div>
            <div class="tag" onclick="setFilter('Eyes', this)">Eyes</div>
            <div class="tag" onclick="setFilter('Lip', this)">Lip</div>
            <div class="tag" onclick="setFilter('å€‹äººè­·ç†', this)">å€‹è­·</div>
            <div class="tag" onclick="setFilter('å…¶ä»–', this)">å…¶ä»–</div>
        </div>
    </div>
    <div id="dash-list"></div>
</div>

<div id="plan-page" class="page">
    <div class="card" style="background:#f0f0f7;">
        <div id="plan-tabs" style="display:flex; gap:8px; overflow-x:auto; padding-bottom:10px;"></div>
        <div style="display:flex; gap:5px;">
            <input type="text" id="newPlanName" placeholder="æ–°è¨ˆç•«åç¨±" style="padding:5px;">
            <button onclick="createNewPlan()" style="background:var(--plan); color:white; border:none; border-radius:8px; padding:0 15px;">æ–°å¢</button>
        </div>
    </div>
    <div id="plan-list"></div>
</div>

<div id="cart-page" class="page">
    <div class="card">
        <h2>ğŸ›’ ç•¶å‰è³¼ç‰©ç±ƒ</h2>
        <div id="cart-list"></div>
        <div id="cart-empty" class="empty-hint">ç±ƒå­æ˜¯ç©ºçš„ï¼Œå»æ¸…å–®æ‰¾æ‰¾å¥½ç‰©å§ï¼</div>
        <hr>
        <div class="form-group" style="margin-top:15px;">
            <input type="text" id="checkoutName" placeholder="ç‚ºé€™æ¬¡è³¼ç‰©å–å (å¦‚: æ˜æ´åº—)">
            <button class="btn-main" style="background:var(--history);" onclick="archiveCart()">å®Œæˆçµå¸³ä¸¦ä¿å­˜è¨˜éŒ„</button>
        </div>
    </div>
</div>

<div id="history-page" class="page">
    <div class="card">
        <h2>ğŸ“œ æ­·å²è³¼è²·è¨˜éŒ„</h2>
        <div id="history-list"></div>
        <div id="history-empty" class="empty-hint">ç›®å‰é‚„æ²’æœ‰å­˜æª”éçš„è³¼ç‰©è¨˜éŒ„ã€‚</div>
    </div>
</div>

<div class="checkout-bar">
    <div class="sum-row"><span>ğŸ“ [<span id="cur-plan-name">é è¨­</span>] è¨ˆç•«ç¸½è¨ˆ</span><span>â‚©<span id="plan-total">0</span></span></div>
    <div class="sum-row" style="color:var(--cart);"><span>ğŸ›’ è³¼ç‰©ç±ƒå¯¦éš›ç¸½è¨ˆ</span><span>â‚©<span id="cart-total">0</span></span></div>
    <div class="sum-row total-row"><span>ç±ƒå…§å¯¦ä»˜ä¼°ç®—</span><span>â‚©<span id="final-total">0</span></span></div>
</div>

<script>
    // æ•¸æ“šåˆå§‹åŒ–
    let db = JSON.parse(localStorage.getItem('oy_db_v30')) || [];
    let allPlans = JSON.parse(localStorage.getItem('oy_plans_v30')) || { "æˆ‘çš„è¨ˆç•«": [] };
    let currentPlanName = localStorage.getItem('oy_cur_plan_v30') || "æˆ‘çš„è¨ˆç•«";
    let cart = JSON.parse(localStorage.getItem('oy_cart_v30')) || [];
    let history = JSON.parse(localStorage.getItem('oy_hist_v30')) || [];
    let currentFilter = 'å…¨éƒ¨';

    const subMap = {
        "è­·è†šå“": ["åŒ–å¦æ°´", "ç²¾è¯", "ä¹³æ¶²", "é¢éœœ", "é¢è†œ", "æ³¥è†œ", "é˜²æ›¬", "æ½”é¢", "å¸å¦", "çœ¼éƒ¨è­·ç†"],
        "Base": ["å¦å‰", "æ°£å¢Š", "ç²‰åº•", "é®ç‘•", "è…®ç´…", "é«˜å…‰", "ä¿®å®¹"],
        "Eyes": ["çœ‰ç­†", "çœ¼å½±", "çœ¼ç·š", "è‡¥è ¶", "ç«æ¯›è†"],
        "Lip": ["å”‡ç·šç­†", "å”‡é‡‰", "å”‡è†"],
        "å€‹äººè­·ç†": ["æ‰‹éƒ¨è­·ç†", "å£è…”æ¸…æ½”", "é¦™æ°›/é¦™æ°´"],
        "å…¶ä»–": ["ç¾å®¹å·¥å…·", "é›¶é£Ÿ", "é£²å“", "ç”Ÿæ´»é›œè²¨"]
    };

    // å­åˆ†é¡é‚è¼¯
    function toggleMakeupSub() {
        const main = document.getElementById('mainCat').value;
        document.getElementById('mk-sub-area').style.display = (main === 'åŒ–å¦å“') ? 'block' : 'none';
        updateSubCat();
    }
    function updateSubCat() {
        const main = document.getElementById('mainCat').value;
        const mkType = document.getElementById('mkType').value;
        const area = document.getElementById('subCatArea');
        let target = (main === 'åŒ–å¦å“') ? mkType : main;
        area.innerHTML = `<select id="subCat">${subMap[target].map(s => `<option value="${s}">${s}</option>`).join('')}</select>`;
    }

    // å­˜å„²åŠŸèƒ½
    function saveProduct() {
        const name = document.getElementById('name').value;
        if(!name) return alert("è«‹è¼¸å…¥åç¨±");
        const p = { id: Date.now(), name, mainCat: document.getElementById('mainCat').value, mkType: document.getElementById('mkType').value, subCat: document.getElementById('subCat').value, price: Number(document.getElementById('price').value), spec: document.getElementById('spec').value, priority: document.getElementById('priority').value };
        db.push(p); localStorage.setItem('oy_db_v30', JSON.stringify(db)); render(); alert("å„²å­˜æˆåŠŸ");
    }

    function createNewPlan() {
        const name = document.getElementById('newPlanName').value.trim();
        if (name && !allPlans[name]) {
            allPlans[name] = []; localStorage.setItem('oy_plans_v30', JSON.stringify(allPlans));
            currentPlanName = name; localStorage.setItem('oy_cur_plan_v30', name);
            document.getElementById('newPlanName').value = ''; render();
        }
    }

    function archiveCart() {
        if(cart.length === 0) return alert("ç±ƒå­æ˜¯ç©ºçš„ï¼");
        const name = document.getElementById('checkoutName').value || `æ¡è³¼æ–¼ ${new Date().toLocaleDateString()}`;
        const record = { id: Date.now(), date: new Date().toLocaleString(), name, total: calculateCartTotal(), items: cart.map(i => {
            const prod = db.find(p => p.id === i.id);
            return { name: prod.name, qty: i.qty, price: prod.price };
        })};
        history.unshift(record); localStorage.setItem('oy_hist_v30', JSON.stringify(history));
        cart = []; localStorage.setItem('oy_cart_v30', JSON.stringify(cart));
        document.getElementById('checkoutName').value = ''; render(); alert("ç´€éŒ„å·²å­˜å…¥æ­·å²ï¼");
    }

    // æ ¸å¿ƒæ¸²æŸ“
    function render() {
        const search = document.getElementById('search').value.toLowerCase();
        const dashCont = document.getElementById('dash-list'); dashCont.innerHTML = '';
        const planCont = document.getElementById('plan-list'); planCont.innerHTML = '';
        const cartCont = document.getElementById('cart-list'); cartCont.innerHTML = '';
        const histCont = document.getElementById('history-list'); histCont.innerHTML = '';
        const planTabs = document.getElementById('plan-tabs'); planTabs.innerHTML = '';

        let pT = 0, cT = 0;

        // æ¸²æŸ“è¨ˆç•«æ¨™ç±¤
        Object.keys(allPlans).forEach(name => {
            planTabs.innerHTML += `<div class="tag ${name===currentPlanName?'active':''}" onclick="selectPlan('${name}')">${name}</div>`;
        });
        document.getElementById('cur-plan-name').innerText = currentPlanName;

        // æ¸²æŸ“æ¸…å–®/è¨ˆç•«/ç±ƒå­
        db.forEach(p => {
            const pItem = allPlans[currentPlanName].find(i => i.id === p.id);
            const cItem = cart.find(i => i.id === p.id);
            const matchesFilter = currentFilter === 'å…¨éƒ¨' || p.mainCat === currentFilter || p.mkType === currentFilter;
            const matchesSearch = p.name.toLowerCase().includes(search);

            const card = `
                <div class="item-card ${pItem?'in-plan':''} ${cItem?'in-cart':''}">
                    <div style="font-size:10px; color:#888;">${p.subCat} | ${p.priority}</div>
                    <div style="font-weight:bold;">${p.name}</div>
                    <div class="price-tag">â‚©${p.price.toLocaleString()} <small style="font-weight:normal; color:#999">(${p.spec})</small></div>
                    <div class="buy-controls">
                        <div class="action-row" style="display:flex; gap:5px;">
                            <button class="btn-act ${pItem?'btn-p':'btn-off'}" onclick="toggleState(${p.id}, 'plan')">${pItem?'âœ“ è¨ˆç•«ä¸­':'ï¼‹å…¥è¨ˆç•«'}</button>
                            <button class="btn-act ${cItem?'btn-c':'btn-off'}" onclick="toggleState(${p.id}, 'cart')">${cItem?'âœ“ å·²å…¥ç±ƒ':'ï¼‹å…¥ç±ƒå­'}</button>
                        </div>
                        ${(pItem || cItem) ? `<div class="qty-row">æ•¸é‡: <input type="number" class="qty-input" value="${(cItem||pItem).qty}" oninput="updateQty(${p.id}, this.value, '${cItem?'cart':'plan'}')"></div>` : ''}
                    </div>
                </div>`;

            if(matchesFilter && matchesSearch) dashCont.innerHTML += card;
            if(pItem) { planCont.innerHTML += card; pT += p.price * pItem.qty; }
            if(cItem) { cartCont.innerHTML += card; cT += p.price * cItem.qty; }
        });

        // æ­·å²ç´€éŒ„
        history.forEach(h => {
            histCont.innerHTML += `
                <div class="card history-item">
                    <div class="history-header"><div style="font-weight:bold;">${h.name}</div><button onclick="delHist(${h.id})" style="color:red; border:none; background:none; font-size:10px;">åˆªé™¤</button></div>
                    <div style="font-size:12px; margin-top:5px; color:#666;">æ—¥æœŸ: ${h.date}<br>æ¸…å–®: ${h.items.map(i => i.name+'x'+i.qty).join(', ')}</div>
                    <div style="text-align:right; font-weight:bold; color:var(--primary); margin-top:5px;">ç¸½è¨ˆ: â‚©${h.total.toLocaleString()}</div>
                </div>`;
        });

        document.getElementById('plan-total').innerText = pT.toLocaleString();
        document.getElementById('cart-total').innerText = cT.toLocaleString();
        document.getElementById('final-total').innerText = (cT >= 15000 ? Math.round(cT * 0.95) : cT).toLocaleString();
        document.getElementById('cart-empty').style.display = cart.length ? 'none' : 'block';
        document.getElementById('history-empty').style.display = history.length ? 'none' : 'block';
    }

    // åŠŸèƒ½å‡½æ•¸
    function toggleState(id, type) {
        let list = type === 'plan' ? allPlans[currentPlanName] : cart;
        let idx = list.findIndex(i => i.id === id);
        if(idx > -1) list.splice(idx,1); else list.push({id, qty:1});
        saveAll(); render();
    }
    function updateQty(id, val, type) {
        let list = type === 'plan' ? allPlans[currentPlanName] : cart;
        let item = list.find(i => i.id === id);
        if(item) { item.qty = parseInt(val) || 1; saveAll(); render(); }
    }
    function saveAll() {
        localStorage.setItem('oy_plans_v30', JSON.stringify(allPlans));
        localStorage.setItem('oy_cart_v30', JSON.stringify(cart));
    }
    function selectPlan(name) { currentPlanName = name; localStorage.setItem('oy_cur_plan_v30', name); render(); }
    function setFilter(f, btn) { currentFilter = f; document.querySelectorAll('.tag').forEach(t => t.classList.remove('active')); btn.classList.add('active'); render(); }
    function calculateCartTotal() { return cart.reduce((sum, i) => sum + (db.find(p => p.id === i.id).price * i.qty), 0); }
    function delHist(id) { if(confirm("åˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ")) { history = history.filter(h => h.id !== id); localStorage.setItem('oy_hist_v30', JSON.stringify(history)); render(); }}
    
    function switchPage(p, btn) {
        document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
        document.getElementById(p + '-page').classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        window.scrollTo(0,0);
    }

    updateSubCat(); render();
</script>
</body>
</html>